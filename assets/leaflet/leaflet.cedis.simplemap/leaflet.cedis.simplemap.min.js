(function($){let ignored_add_layer=false;window.oesMap={maps:[],settings:[],allMarkers:[],maplayers:{},layerGroups:{}};oesMap.init=function(elementName,data,options){const defaults={showLegend:false,controlsCollapsed:true,controlText:"Legend",legendLabelType:"Choose Type",legendLabelBorders:"Show borders",fitBounds:false,showBorders:true,defaultZoom:5,defaultCenter:[51.582275,10.653294]};const validated_options=$.extend({},defaults,options||{});oesMap.markers=[];oesMap.settings[elementName]=[];const tile=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Daten von <a href="http://www.openstreetmap.org/">OpenStreetMap</a> - Ver√∂ffentlicht unter <a href="http://opendatacommons.org/licenses/odbl/">ODbL</a>'});oesMap.maps[elementName]=L.map(elementName,{center:oesMap.settings[elementName]["center"]===undefined?validated_options.defaultCenter:oesMap.settings[elementName]["center"],zoom:oesMap.settings[elementName]["zoom"]===undefined?validated_options.defaultZoom:oesMap.settings[elementName]["zoom"],layers:[tile],maxZoom:18,scrollWheelZoom:false});oesMap.maplayers[elementName]=[];if(screen.availWidth<768)validated_options.showLegend=false;const control_layers=new L.control.layers(null,null,{collapsed:validated_options.controlsCollapsed});let allMarkers=[];allMarkers[elementName]=[];$.each(data,function(i,row){const group_title=row.title,markers_data=row.data;let markers=[];var layerGroup=L.layerGroup();layerGroup.oes_id=elementName+"_"+i;console.log(layerGroup.oes_id);if(markers_data.length>0){let post_filter="";for(let key in markers_data){post_filter=post_filter+" oes-post-filter-"+markers_data[key]["post_id"]}let marker_icon_class,marker_color;markers_data.forEach(function(marker_data,index){if(marker_data.color!==undefined){marker_color=marker_data.color}circleMarker=L.circleMarker([marker_data.lat,marker_data.lon],{radius:5,fillColor:marker_data.color,color:marker_data.color,weight:1,opacity:1,fillOpacity:1});circleMarker.bindPopup(marker_data.popup_text);circleMarker.addTo(layerGroup);markers.push(circleMarker)});const iconHTML='<svg class="MapFilter-icon u-ml-tiny" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><circle cx="25" cy="25" r="20" stroke="'+marker_color+'" fill="'+marker_color+'" fill-opacity="1" stroke-opacity="1" stroke-width="1"></circle></svg>';layerGroup.addTo(oesMap.maps[elementName]);oesMap.layerGroups[elementName+"_"+i]=layerGroup;if(validated_options.showLegend===true){control_layers.addOverlay(layerGroup,'<div class="oes-map-group-title">'+iconHTML+group_title+"</div>");control_layers.addTo(oesMap.maps[elementName])}if(validated_options.controlsCollapsed===true){$("#"+validated_options.map_id+" .leaflet-control-layers").hide(1)}allMarkers[elementName]=allMarkers[elementName].concat(markers)}});oesMap.allMarkers[elementName]=allMarkers[elementName];$('<div id="oes-map-legend" class="leaflet-control-layers-expanded leaflet-control">'+validated_options.controlText+'&nbsp;&nbsp;<i class="fa fa-caret-down"></i></div>').insertBefore("#"+validated_options.map_id+" div.leaflet-control-layers");$('<div class="oes-map-help">'+validated_options.legendLabelType+"</div>").insertBefore("#"+validated_options.map_id+" div.leaflet-control-layers-overlays");if(validated_options.showBorders!==false&&validated_options.layer_files.length>0){$('<div id="oes-overlay-filter-header">'+validated_options.legendLabelBorders+"</div>").insertAfter("#"+validated_options.map_id+" div.leaflet-control-layers-overlays");validated_options.layer_files.forEach(function(layer_file){const geoJsonData=$.getJSON(layer_file.url);const id=layer_file.id;const exteriorStyle={color:"orange",weight:1,fillOpacity:0,opacity:1};geoJsonData.then(function(data){var geoJson=L.geoJSON(data,{style:exteriorStyle}).addTo(oesMap.maps[elementName]);checked="";oesMap.maplayers[elementName][id]=oesMap.maplayers[id]||[];oesMap.maplayers[elementName][id].push(geoJson);$('<div><label><input type="checkbox" id="oes-map-layer-'+elementName+"_"+id+'" checked>'+layer_file.name+" </label</div>").insertAfter("#"+validated_options.map_id+" div#oes-overlay-filter-header");$("#oes-map-layer-"+elementName+"_"+id).change(function(){if($(this).is(":checked")){oesMap.maplayers[elementName][id][0].addTo(oesMap.maps[elementName])}else{oesMap.maplayers[elementName][id][0].removeFrom(oesMap.maps[elementName])}})})})}if(validated_options.fitBounds!==false){var bounds=L.latLngBounds(allMarkers[elementName])}console.log("mapid: "+validated_options.map_id);$("#"+validated_options.map_id+" #oes-map-legend").click(function(){$("#"+validated_options.map_id+" .leaflet-control-layers").toggle("1000")});oesMap.maps[elementName].on("overlayadd",function(e){let test=e.name.split('<div class="oes-map-group-title">');const title=test[1].replace("</span>","").replace("</div>","")});oesMap.maps[elementName].on("overlayremove",function(e){let test=e.name.split('<div class="oes-map-group-title">');const title=test[1].replace("</span>","").replace("</div>","")});oesMap.maps[elementName].on("moveend",function(e){oesMap.settings[elementName]["center"]=oesMap.maps[elementName].getCenter()})}})(jQuery);